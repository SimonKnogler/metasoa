<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDT Browser Compatibility Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-section h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-item:last-child {
            border-bottom: none;
        }
        
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status.pass {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .status.fail {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .status.warn {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .status.pending {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }
        
        #mouse-test-area {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }
        
        .shape {
            position: absolute;
            width: 40px;
            height: 40px;
            transition: none;
        }
        
        #test-square {
            background: #00d4ff;
            left: 30%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        #test-circle {
            background: #ff6b6b;
            border-radius: 50%;
            left: 70%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .metric-label {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        
        button {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        #frame-rate-chart {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .instructions {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .summary {
            text-align: center;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .summary.warning {
            background: rgba(255, 170, 0, 0.1);
        }
        
        .summary.error {
            background: rgba(255, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ CDT Browser Compatibility Test</h1>
        
        <div class="instructions">
            <strong>Instructions:</strong> This page tests if your browser is compatible with the CDT experiment.
            All tests should pass for optimal performance. Move your mouse in the test area below to check tracking.
        </div>
        
        <!-- Browser Detection -->
        <div class="test-section">
            <h2>üåê Browser Information</h2>
            <div class="test-item">
                <span>Browser</span>
                <span id="browser-name" class="status pending">Detecting...</span>
            </div>
            <div class="test-item">
                <span>Version</span>
                <span id="browser-version" class="status pending">Detecting...</span>
            </div>
            <div class="test-item">
                <span>Platform</span>
                <span id="platform" class="status pending">Detecting...</span>
            </div>
        </div>
        
        <!-- Core Features -->
        <div class="test-section">
            <h2>‚öôÔ∏è Core Features</h2>
            <div class="test-item">
                <span>WebGL Support</span>
                <span id="webgl-support" class="status pending">Testing...</span>
            </div>
            <div class="test-item">
                <span>RequestAnimationFrame</span>
                <span id="raf-support" class="status pending">Testing...</span>
            </div>
            <div class="test-item">
                <span>Performance API</span>
                <span id="perf-api" class="status pending">Testing...</span>
            </div>
            <div class="test-item">
                <span>Fetch API</span>
                <span id="fetch-api" class="status pending">Testing...</span>
            </div>
            <div class="test-item">
                <span>Local Storage</span>
                <span id="local-storage" class="status pending">Testing...</span>
            </div>
        </div>
        
        <!-- Mouse Tracking Test -->
        <div class="test-section">
            <h2>üñ±Ô∏è Mouse Tracking Test</h2>
            <p style="margin-bottom: 15px; color: #888;">Move your mouse in the area below. The blue square should follow your movement.</p>
            <div id="mouse-test-area">
                <div id="test-square" class="shape"></div>
                <div id="test-circle" class="shape"></div>
            </div>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="mouse-x">0</div>
                    <div class="metric-label">Mouse X</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="mouse-y">0</div>
                    <div class="metric-label">Mouse Y</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="mouse-speed">0</div>
                    <div class="metric-label">Speed (px/s)</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="tracking-latency">0</div>
                    <div class="metric-label">Latency (ms)</div>
                </div>
            </div>
        </div>
        
        <!-- Frame Rate Test -->
        <div class="test-section">
            <h2>üìä Frame Rate Test</h2>
            <div class="button-group">
                <button onclick="startFrameRateTest()">Start 5-Second Test</button>
                <button onclick="stopFrameRateTest()">Stop</button>
            </div>
            <canvas id="frame-rate-chart"></canvas>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="current-fps">--</div>
                    <div class="metric-label">Current FPS</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avg-fps">--</div>
                    <div class="metric-label">Average FPS</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="min-fps">--</div>
                    <div class="metric-label">Min FPS</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="max-fps">--</div>
                    <div class="metric-label">Max FPS</div>
                </div>
            </div>
        </div>
        
        <!-- Resource Loading Test -->
        <div class="test-section">
            <h2>üì¶ Resource Loading Test</h2>
            <div class="test-item">
                <span>Motion Library (3.5 MB)</span>
                <span id="motion-lib-status" class="status pending">Not tested</span>
            </div>
            <div class="test-item">
                <span>Trajectory Pairs</span>
                <span id="pairs-status" class="status pending">Not tested</span>
            </div>
            <div class="test-item">
                <span>Load Time</span>
                <span id="load-time" class="status pending">--</span>
            </div>
            <div class="button-group">
                <button onclick="testResourceLoading()">Test Resource Loading</button>
            </div>
        </div>
        
        <!-- Summary -->
        <div id="summary" class="summary" style="display: none;">
            <h2 id="summary-title">Test Results</h2>
            <p id="summary-text"></p>
        </div>
    </div>
    
    <script>
        // Browser detection
        function detectBrowser() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            let version = 'Unknown';
            
            if (ua.includes('Chrome') && !ua.includes('Edg')) {
                browser = 'Chrome';
                version = ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Firefox')) {
                browser = 'Firefox';
                version = ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
                browser = 'Safari';
                version = ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Edg')) {
                browser = 'Edge';
                version = ua.match(/Edg\/(\d+)/)?.[1] || 'Unknown';
            }
            
            document.getElementById('browser-name').textContent = browser;
            document.getElementById('browser-name').className = 'status ' + 
                (browser === 'Chrome' || browser === 'Firefox' ? 'pass' : 'warn');
            
            document.getElementById('browser-version').textContent = version;
            document.getElementById('browser-version').className = 'status pass';
            
            document.getElementById('platform').textContent = navigator.platform;
            document.getElementById('platform').className = 'status pass';
        }
        
        // Core feature tests
        function testCoreFeatures() {
            // WebGL
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            setStatus('webgl-support', gl ? 'Supported' : 'Not Supported', !!gl);
            
            // RequestAnimationFrame
            setStatus('raf-support', window.requestAnimationFrame ? 'Supported' : 'Not Supported', 
                      !!window.requestAnimationFrame);
            
            // Performance API
            setStatus('perf-api', window.performance?.now ? 'Supported' : 'Not Supported',
                      !!window.performance?.now);
            
            // Fetch API
            setStatus('fetch-api', window.fetch ? 'Supported' : 'Not Supported', !!window.fetch);
            
            // Local Storage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                setStatus('local-storage', 'Supported', true);
            } catch (e) {
                setStatus('local-storage', 'Not Supported', false);
            }
        }
        
        function setStatus(id, text, pass) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = 'status ' + (pass ? 'pass' : 'fail');
        }
        
        // Mouse tracking test
        const testArea = document.getElementById('mouse-test-area');
        const testSquare = document.getElementById('test-square');
        const testCircle = document.getElementById('test-circle');
        let lastMouseTime = performance.now();
        let lastMouseX = 0, lastMouseY = 0;
        
        testArea.addEventListener('mousemove', (e) => {
            const rect = testArea.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Update square position (follows mouse)
            testSquare.style.left = x + 'px';
            testSquare.style.top = y + 'px';
            
            // Update circle position (delayed/trajectory simulation)
            const circleX = parseFloat(testCircle.style.left) || rect.width * 0.7;
            const circleY = parseFloat(testCircle.style.top) || rect.height * 0.5;
            testCircle.style.left = (circleX + (Math.random() - 0.5) * 5) + 'px';
            testCircle.style.top = (circleY + (Math.random() - 0.5) * 5) + 'px';
            
            // Calculate metrics
            const now = performance.now();
            const dt = (now - lastMouseTime) / 1000;
            const dx = x - lastMouseX;
            const dy = y - lastMouseY;
            const speed = Math.sqrt(dx*dx + dy*dy) / dt;
            
            document.getElementById('mouse-x').textContent = x.toFixed(0);
            document.getElementById('mouse-y').textContent = y.toFixed(0);
            document.getElementById('mouse-speed').textContent = speed.toFixed(0);
            document.getElementById('tracking-latency').textContent = (now - lastMouseTime).toFixed(1);
            
            lastMouseTime = now;
            lastMouseX = x;
            lastMouseY = y;
        });
        
        // Frame rate test
        let frameRateTestRunning = false;
        let frameTimestamps = [];
        let fpsHistory = [];
        let frameRateAnimationId = null;
        
        function startFrameRateTest() {
            frameRateTestRunning = true;
            frameTimestamps = [];
            fpsHistory = [];
            
            const startTime = performance.now();
            const duration = 5000; // 5 seconds
            
            function measureFrame() {
                if (!frameRateTestRunning) return;
                
                const now = performance.now();
                frameTimestamps.push(now);
                
                // Keep last 60 frames
                if (frameTimestamps.length > 60) {
                    frameTimestamps.shift();
                }
                
                // Calculate FPS
                if (frameTimestamps.length >= 2) {
                    const dt = frameTimestamps[frameTimestamps.length - 1] - frameTimestamps[0];
                    const fps = (frameTimestamps.length - 1) / (dt / 1000);
                    fpsHistory.push(fps);
                    
                    document.getElementById('current-fps').textContent = fps.toFixed(1);
                    
                    if (fpsHistory.length > 0) {
                        const avg = fpsHistory.reduce((a, b) => a + b) / fpsHistory.length;
                        const min = Math.min(...fpsHistory);
                        const max = Math.max(...fpsHistory);
                        
                        document.getElementById('avg-fps').textContent = avg.toFixed(1);
                        document.getElementById('min-fps').textContent = min.toFixed(1);
                        document.getElementById('max-fps').textContent = max.toFixed(1);
                    }
                    
                    drawFpsChart();
                }
                
                if (now - startTime < duration) {
                    frameRateAnimationId = requestAnimationFrame(measureFrame);
                } else {
                    stopFrameRateTest();
                    showSummary();
                }
            }
            
            frameRateAnimationId = requestAnimationFrame(measureFrame);
        }
        
        function stopFrameRateTest() {
            frameRateTestRunning = false;
            if (frameRateAnimationId) {
                cancelAnimationFrame(frameRateAnimationId);
            }
        }
        
        function drawFpsChart() {
            const canvas = document.getElementById('frame-rate-chart');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (fpsHistory.length < 2) return;
            
            // Draw 60 FPS line
            ctx.strokeStyle = 'rgba(0, 255, 136, 0.3)';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            const y60 = canvas.height - (60 / 120) * canvas.height;
            ctx.moveTo(0, y60);
            ctx.lineTo(canvas.width, y60);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw FPS history
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const displayHistory = fpsHistory.slice(-100);
            for (let i = 0; i < displayHistory.length; i++) {
                const x = (i / displayHistory.length) * canvas.width;
                const y = canvas.height - (Math.min(displayHistory[i], 120) / 120) * canvas.height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
        }
        
        // Resource loading test
        async function testResourceLoading() {
            const startTime = performance.now();
            
            setStatus('motion-lib-status', 'Loading...', true);
            setStatus('pairs-status', 'Loading...', true);
            
            try {
                // Test motion library
                const motionResponse = await fetch('../resources/motion_library.json');
                if (motionResponse.ok) {
                    const data = await motionResponse.json();
                    setStatus('motion-lib-status', `Loaded (${data.metadata.total_selected} trajectories)`, true);
                } else {
                    setStatus('motion-lib-status', 'Failed to load', false);
                }
            } catch (e) {
                setStatus('motion-lib-status', 'Error: ' + e.message, false);
            }
            
            try {
                // Test trajectory pairs
                const pairsResponse = await fetch('../resources/trajectory_pairs.json');
                if (pairsResponse.ok) {
                    const data = await pairsResponse.json();
                    setStatus('pairs-status', `Loaded (${data.n_pairs} pairs)`, true);
                } else {
                    setStatus('pairs-status', 'Failed to load', false);
                }
            } catch (e) {
                setStatus('pairs-status', 'Error: ' + e.message, false);
            }
            
            const loadTime = performance.now() - startTime;
            document.getElementById('load-time').textContent = (loadTime / 1000).toFixed(2) + 's';
            document.getElementById('load-time').className = 'status ' + (loadTime < 5000 ? 'pass' : 'warn');
        }
        
        // Show summary
        function showSummary() {
            const summary = document.getElementById('summary');
            const title = document.getElementById('summary-title');
            const text = document.getElementById('summary-text');
            
            const avgFps = fpsHistory.length > 0 ? 
                fpsHistory.reduce((a, b) => a + b) / fpsHistory.length : 0;
            
            if (avgFps >= 55) {
                summary.className = 'summary';
                title.textContent = '‚úÖ Excellent Performance';
                text.textContent = `Your browser achieved ${avgFps.toFixed(1)} FPS average. This is ideal for the CDT experiment.`;
            } else if (avgFps >= 45) {
                summary.className = 'summary warning';
                title.textContent = '‚ö†Ô∏è Acceptable Performance';
                text.textContent = `Your browser achieved ${avgFps.toFixed(1)} FPS average. The experiment should work, but performance may vary.`;
            } else {
                summary.className = 'summary error';
                title.textContent = '‚ùå Performance Issues';
                text.textContent = `Your browser achieved only ${avgFps.toFixed(1)} FPS average. Consider using Chrome or Firefox for better performance.`;
            }
            
            summary.style.display = 'block';
        }
        
        // Initialize
        detectBrowser();
        testCoreFeatures();
    </script>
</body>
</html>
